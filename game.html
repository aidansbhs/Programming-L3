<!doctype html>

<head>
  <title>Alcazar age</title>
</head>

<body>
  <canvas id="gameCanvas" width="1600" height="800"></canvas>
  <script src="player.js"></script>
  <script src="enemy.js"></script>
  <script src="projectiles.js"></script>
</body>
<script>
  var canvas, canvasContext;

  window.onload = function () {
    canvas = document.getElementById('gameCanvas');
    canvasContext = canvas.getContext('2d');

    setInterval(mainloop, 1000 / 50);

    imageAssets = loadImages();

    document.addEventListener('keydown', keyPressed);
    document.addEventListener('keyup', keyReleased);

    canvas.addEventListener('mousemove', function (evt) {
      var mousePos = mouseAction(evt);
      mouseX = mousePos.x;
      mouseY = mousePos.y;
    });

    var mouseX, mouseY;
  }

  var setUp = true;
  var setUp2 = true;
  var setUp3 = true;
  var yWall = 0;
  var xWall = 0;
  var maxArrows = 4;
  var arrowCount = 0;

  var gameStart = false;
  var mainMenu = true;

  //movement


  //player 1
  const A_KEY = 65;
  const D_KEY = 68;
  const W_KEY = 87;
  const S_KEY = 83;
  const SPACE_KEY = 32;
  const Q_KEY = 81;
  const X_KEY = 88;
  var aKeyPressed = false;
  var dKeyPressed = false;
  var wKeyPressed = false;
  var sKeyPressed = false;
  var spacePressed = false;
  var qKeyPressed = false; //shoot
  var xKeyPressed = false; //attack

  var gravity = 0.1;
  var jumpForce = -30;
  var jumping = false;
  var health = 100;
  var dead = false;

  //variables 

  //player 1
  var pXpos = 0;
  var pYpos = 0;
  var pXspeed = 5;
  var pYspeed = 5;
  const P_SIZE = 40;

  var player = new Player(pXpos, pYpos, P_SIZE, P_SIZE, 'blue', pXspeed, pYspeed);

  //arrays
  var enemies = [];
  var arrows = [];

  function mainloop() {
    if (mainMenu == false) {
      if (dead == false) {
        if (gameStart == true) {
          drawImage(imageAssets.background1, 0, 0, canvas.width, canvas.height); //bg    
          drawLine(canvasContext, [170, 300], [-2, 600], 'black', 5); //diagonal
          drawLine(canvasContext, [168, 300], [1600, 300], 'black', 5); //straight horizontal
          colorRect(170, 302.5, canvas.width, canvas.height, '#8b5a2b'); //brown floor rectangle
          drawTriangle();

          if (setUp2) {
            gameSetup();
            for (var i = 0; i < 3; i++) {
              createEnemy();
            }
            setUp2 = false;
          }
          // console.log(mouseY);
          // console.log(mouseX);

          player.drawRect();
          player.movement();
          // player.jump();
          // player.gravity();
          player.depth();
          player.collision();
          // player.gameOver();

          if (enemies.length > 0) { //enemies
            enemies.forEach(function (enemy, i, array) {
              enemy.drawRect();
              enemy.movement();
            });
          }

          if (arrows.length > 0) { //arrows
            arrows.forEach(function (arrow, i, array) {
              arrow.drawRect();
              arrow.arrowMovement();

              // if (arrow.outOfbounds() || arrow.collision()) { //if the bullet hits enemy or goes out of canvas it will be deleted
              if (arrow.collision()) {
                if (arrow.outOfbounds()) {
                  delete array[i];
                  if (arrowCount >= 0) { //so arrowCount can't go into negatives
                    arrowCount -= 1;
                  }
                }
                createEnemy(); //works for both outofBounds and collision (bug)
              }
              arrows = arrows.filter(item => item !== undefined);
            });
          }
        }
      } else if (dead == true) {
        player.gameOver();
      }
    } else {
      drawImage(imageAssets.menuScreen, 0, 0, canvas.width, canvas.height); //menu screen
    }
  } //end of mainloop

  function gameSetup() {
    yWall = canvas.height / 2.64465;
    xWall = canvas.width / 9;
  } //end of gameSetup

  function loadImages() { //images are stored here
    imgs = [];
    imgs.background1 = new Image();
    imgs.background1.src = 'imgs/Background/background1.png'; //background
    imgs.menuScreen = new Image();
    imgs.menuScreen.src = 'imgs/Background/menuScreen.png'; //menu screen
    return imgs;
  } //end of loadImages

  function createEnemy() {
    eSize = 40;
    eYpos = Math.floor(Math.random() * (yWall - 0) + yWall); //random y wall spawn point 
    eXpos = Math.floor(Math.random() * (1600 - 1400) +
      1600); //makes it random spawing outside maps so won't spawn inside of each other
    eXspeed = 3;
    eYspeed = Math.floor(Math.random() * (12 - 3) + 3);

    var enemy = new Enemy(eXpos, eYpos, eSize, eSize, 'yellow', eXspeed, eYspeed);

    enemies.push(enemy);
  } //end of createEnemy

  function createProjectile() {
    var aSize = 10;
    var aYpos = player.y;
    var aXpos = player.x + player.w / 2;
    var aXspeed = 7.5;

    var arrow = new Arrow(aXpos, aYpos, aSize, aSize, 'white', aXspeed);

    arrows.push(arrow);
    arrowCount += 1;
  } //end of createProjectile

  function mouseAction(evt) {
    var rect = canvas.getBoundingClientRect();
    var root = document.documentElement;

    mouseX = evt.clientX - rect.left - root.scrollLeft;
    mouseY = evt.clientY - rect.top - root.scrollTop;

    return {
      x: mouseX,
      y: mouseY
    }
  }

  function keyPressed(evt) {
    if (evt.keyCode == A_KEY) {
      aKeyPressed = true;
    }
    if (evt.keyCode == D_KEY) {
      dKeyPressed = true;
    }
    if (evt.keyCode == W_KEY) {
      wKeyPressed = true;
    }
    if (evt.keyCode == S_KEY) {
      sKeyPressed = true;
    }
    if (evt.keyCode == SPACE_KEY) {
      spacePressed = true;
    }
    if (evt.keyCode == Q_KEY) {
      qKeyPressed = true;
      if (arrowCount <
        maxArrows
      ) { //makes it so there is can only be a max of 4 arrows on the screen otherwise the player can 'spam' the ability
        createProjectile();
      }
    }
    if (evt.keyCode == X_KEY) {
      xKeyPressed = true;
    } //player 1
  } //end of keyPressed

  function keyReleased(evt) {
    if (evt.keyCode == A_KEY) {
      aKeyPressed = false;
    }
    if (evt.keyCode == D_KEY) {
      dKeyPressed = false;
    }
    if (evt.keyCode == W_KEY) {
      wKeyPressed = false;
    }
    if (evt.keyCode == S_KEY) {
      sKeyPressed = false;
    }
    if (evt.keyCode == SPACE_KEY) {
      spacePressed = false;
    }
    if (evt.keyCode == Q_KEY) {
      qKeyPressed = false;
    }
    if (evt.keyCode == X_KEY) {
      xKeyPressed = false;
    } //player 1
  } //end of keyReleased

  function drawImage(src, x, y, w, h) {
    canvasContext.drawImage(src, x, y, w, h);
  } //end of drawImage

  function drawLine(canvasContext, begin, end, stroke = 'grey', width = 1) {
    canvasContext.beginPath();
    canvasContext.moveTo(...begin); //could make variables for (x,y)
    canvasContext.lineTo(...end);
    canvasContext.stroke();
    canvasContext.strokeStyle = stroke;
    canvasContext.lineWidth = width;
  } //end of drawLine

  function drawTriangle() {
    canvasContext.beginPath();
    canvasContext.moveTo(0, 602.5);
    canvasContext.lineTo(canvas.width, canvas.height);
    canvasContext.lineTo(168, 304.5);
    canvasContext.fill();
  }

  function colorRect(x, y, w, h, c) {
    canvasContext.fillStyle = c;
    canvasContext.fillRect(x, y, w, h);
  } //end of colorRect
</script>
<style>
  * {
    margin: 0px;
    padding: 0px;
  }

  canvas {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    margin-top: 5vh;
    display: block;
  }
</style>