<!doctype html>

<head>
  <title>Alcazar age</title>
</head>

<body>
  <canvas id="gameCanvas" width="1600" height="800"></canvas>
  <script src="player.js"></script>
  <script src="enemies.js"></script>
  <script src="projectiles.js"></script>
</body>
<script>
  var canvas, canvasContext;

  window.onload = function () {
    canvas = document.getElementById('gameCanvas');
    canvasContext = canvas.getContext('2d');

    imageAssets = loadImages();

    document.addEventListener('keydown', keyPressed);
    document.addEventListener('keyup', keyReleased);

    canvas.addEventListener('mousemove', function (evt) {
      var mousePos = mouseAction(evt);
      mouseX = mousePos.x;
      mouseY = mousePos.y;
      buttons("mousemove");
    });

    canvas.addEventListener("mousedown", function (evt) {
      var mousePos = mouseAction(evt);
      mouseX = mousePos.x;
      mouseY = mousePos.y;
      mouseDown = true;
      buttons();
    });

    canvas.addEventListener("mouseup", function (evt) {
      buttons("run");
      mouseDown = false;
    });

    setInterval(mainloop, 1000 / 50);
  }

  var mouseX = 0;
  var mouseY = 0;
  var mouseDown = false;

  var pSetUp = true;
  var kSetUp = true;
  var aSetUp = true;
  var gameStart = true;
  var yWall = 0;
  var xWall = 0;
  var maxArrows = 4;
  var arrowCount = 0;
  var maxArcherArrows = 0; //updated in for loop
  var maxPerArcher = 3;
  var archerArrowCount = 0;
  var past = true;

  var singlePlayer = false;
  var multiPlayer = false;
  var gameState = 'mainMenu';

  //movement

  //player 1
  const A_KEY = 65;
  const D_KEY = 68;
  const W_KEY = 87;
  const S_KEY = 83;
  const SPACE_KEY = 32;
  const Q_KEY = 81;
  const X_KEY = 88;
  var aKeyPressed = false;
  var dKeyPressed = false;
  var wKeyPressed = false;
  var sKeyPressed = false;
  var spacePressed = false;
  var qKeyPressed = false; //shoot
  var xKeyPressed = false; //attack
  var gravity = 0.1;
  var jumpForce = -30;
  var jumping = false;
  var health = 100;

  //variables 

  //player 1
  var pXpos = 0;
  var pYpos = 0;
  var pXspeed = 5;
  var pYspeed = 5;
  const P_SIZE = 40;

  var player = new Player(pXpos, pYpos, P_SIZE, P_SIZE, 'blue', pXspeed, pYspeed);

  //arrays
  var knights = [];
  var archers = [];
  var tanks = [];
  var playerArrows = [];
  var archerArrows = [];

  function mainloop() {
    // console.log(gameState);
    if (gameState == 'playing') {
      if (gameStart == true) {
        gameSetup();
        for (var i = 0; i < 3; i++) { //for loop for knights so it pushes three at start
          createKnight();
        }
        for (var i = 0; i < 3; i++) {
          createArcher();
          maxArcherArrows = maxPerArcher * JSON.parse(JSON.stringify(archers.length));
        }
        for (var i = 0; i < 3; i++) {
          createTank();
        }
        gameStart = false;
      }

      drawImage(imageAssets.background1, 0, 0, canvas.width, canvas.height); //bg    

      if (singlePlayer == true) {
        gameSetup();
      }

      if (multiPlayer == true) {
        gameSetup();
      }
      player.drawRect();
      player.movement();
      player.depth();
      player.collision();
      player.attacking();

      player.arrows.forEach(function (playerArrow, i, array) {
        playerArrow.drawRect();
        playerArrow.movement();

        if (playerArrow.outOfbounds()) {
          delete array[i]; //if the bullet goes out of canvas it will be deleted
          player.arrows = player.arrows.filter(item => item !== undefined);
          //checks if arrows are undefined (from when they get deleted) and will actually remove them 
        }
        if (playerArrow.knightCollision()) {
          delete array[i]; //same thing for when bullet hits knight
          createKnight(); //creates a new knight 
          player.arrows = player.arrows.filter(item => item !== undefined);
          //checks if arrows are undefined (from when they get deleted) and will actually remove them
        }
        if (playerArrow.archerCollision()) {
          delete array[i]; //same thing for when bullet hits knight
          createArcher(); //creates a new knight 
          player.arrows = player.arrows.filter(item => item !== undefined);
          //checks if arrows are undefined (from when they get deleted) and will actually remove them
        }
      });

      if (knights.length > 0) { //knights
        knights.forEach(function (knight, i, array) {
          knight.drawRect();
          knight.movement();
        });
      }

      if (archers.length > 0) { //archers
        archers.forEach(function (archer, i, array) {
          archer.drawRect();
          archer.movement();
          archer.shooting();

          archer.arrows.forEach(function (archerArrow, i, array) {
            //made an array for arrows in archers class and therefore will run for each archer, making it so the arrows are distributed equally
            archerArrow.drawRect();
            archerArrow.movement();

            if (archerArrow.outOfbounds() || archerArrow.playerCollision()) {
              delete array[i]; //if the bullet goes out of canvas it will be deleted
              archer.arrows = archerArrows.filter(item => item !== undefined);
              //checks if arrows are undefined (from when they get deleted) and will actually remove them 
              if (archerArrowCount > 0) { //so arrowCount can't go into negatives
                archerArrowCount -= 1;
              }
            }
          });
        });
      }

      if (tanks.length > 0) { //tanks
        tanks.forEach(function (tank, i, array) {
          tank.drawRect();
          tank.movement();
        });
      }

    } else if (gameState == 'mainMenu') {
      drawMenu();
    } else if (gameState == 'gameOver') {
      player.gameOver();
    }
  } //end of mainloop

  function gameSetup() {
    drawLine(canvasContext, [170, 300], [-2, 600], 'black', 5); //diagonal
    drawLine(canvasContext, [168, 300], [1600, 300], 'black', 5); //straight horizontal
    colorRect(170, 302.5, canvas.width, canvas.height, '#8b5a2b'); //brown floor rectangle
    drawTriangle();

    if (pSetUp) { //start pos
      player.x = canvas.width / 2 - player.w;
      player.y = canvas.height - player.h;
      pSetUp = false;
    }

    yWall = canvas.height / 2.64465;
    xWall = canvas.width / 9;
  } //end of gameSetup

  function loadImages() { //images are stored here
    imgs = [];
    imgs.background1 = new Image();
    imgs.background1.src = 'imgs/Background/background1.png'; //background
    imgs.menuScreen = new Image();
    imgs.menuScreen.src = 'imgs/Background/menuScreen.png'; //menu screen
    return imgs;
  } //end of loadImages

  function drawMenu() {
    drawImage(imageAssets.menuScreen, 0, 0, canvas.width, canvas.height); //menu screen
    var xBox = canvas.width / 2 - 130; //coordinates of boxes
    var yBox = canvas.height / 2.5; //cordinates of boxes
    for (let i = 0; i < 3; i++) { //for loop for 3 boxes
      drawSquare(xBox, yBox + (i * (85 + 35)), 250, 85, 'grey')
      if (mouseY > yBox + (i * (85 + 35)) && mouseX > xBox && mouseY < yBox + (i * (85 + 35) + 85) && mouseX < xBox +
        250) { //hitbox for when mouse goes over boxes
        colorRect(xBox, yBox + (i * (85 + 35)), 250, 85, 'rgb(0,0,0,0.2'); //hover
      }
    }
    drawText('Single Player', canvas.width / 2.245, canvas.height / 2.13, '30px serif', 'black'); //text
    drawText('Multi Player', canvas.width / 2.215, canvas.height / 1.61, '30px serif', 'black');
    drawText('Instructions', canvas.width / 2.215, canvas.height / 1.3, '30px serif', 'black');
  } //end of menuSelection

  function buttons(x) {
    if (gameState == 'mainMenu') {
      var xBox = canvas.width / 2 - 130; //cordinates of boxes
      var yBox = canvas.height / 2.5; //cordinates of boxes
      for (let i = 0; i < 3; i++) { //for loop for 3 boxes
        if (mouseY > yBox + (i * (85 + 35)) && mouseX > xBox && mouseY < yBox + (i * (85 + 35) + 85) && mouseX < xBox +
          250) { //hitbox for when mouse goes over boxes
          if (i == 0 && mouseDown == true && x == "run") {
            singlePlayer = true;
            gameState = 'playing';
          }
          if (i == 1 && mouseDown == true && x == "run") {
            multiPlayer = true;
            gameState = 'playing';
          }
          if (i == 2 && mouseDown == true && x == "run") {
            console.log('instructions');
          }
        }
      }
    }
  } //end of buttons

  function createKnight() {
    kSize = 40;
    kYpos = Math.floor(Math.random() * (yWall - 0) + yWall); //random y wall spawn point 
    kXpos = Math.floor(Math.random() * (1650 - 1400) +
      1650); //makes it random spawing outside maps so won't spawn inside of each other
    kXspeed = 3;
    kYspeed = Math.floor(Math.random() * (12 - 3) + 3);

    var knight = new Knight(kXpos, kYpos, kSize, kSize, 'yellow', kXspeed, kYspeed);

    knights.push(knight);
  } //end of createKnight

  function createArcher() { //only runs once based off gamestart
    aSize = 40;
    aYpos = Math.floor(Math.random() * (yWall - 0) + yWall);
    aXpos = Math.floor(Math.random() * (1600 - 1400) +
      1600); //makes it random spawing outside maps so won't spawn inside of each other;
    aXspeed = 6;
    aYspeed = Math.floor(Math.random() * (12 - 3) + 3);

    var archer = new Archer(aXpos, aYpos, aSize, aSize, 'orange', aXspeed, aYspeed);

    if (knights.length <= 0) {
      archers.push(archer);
    } else {
      knights.forEach(knight => { //for each knight
        if (knight.x <= canvas.width / 5 * 3.75) { //if past certain point on canvas
          past = false;
          archers.push(archer);
        }
      });
    }
  } //end of createArcher

  function createTank() {
    tSize = 60;
    tYpos = Math.floor(Math.random() * (yWall - 0) + yWall); //random y wall spawn point 
    tXpos = Math.floor(Math.random() * (1650 - 1400) + 1650);
    tXspeed = 2;
    tYspeed = Math.floor(Math.random() * (12 - 3) + 3);

    var tank = new Tank(tXpos, tYpos, tSize, tSize, 'red', tXspeed, tYspeed);

    tanks.push(tank);
  } //end of createKnight

  function mouseAction(evt) {
    var rect = canvas.getBoundingClientRect();
    var root = document.documentElement;

    mouseX = evt.clientX - rect.left - root.scrollLeft;
    mouseY = evt.clientY - rect.top - root.scrollTop;

    return {
      x: mouseX,
      y: mouseY
    }
  } //end of mouseAction

  function keyPressed(evt) {
    if (evt.keyCode == A_KEY) {
      aKeyPressed = true;
    }
    if (evt.keyCode == D_KEY) {
      dKeyPressed = true;
    }
    if (evt.keyCode == W_KEY) {
      wKeyPressed = true;
    }
    if (evt.keyCode == S_KEY) {
      sKeyPressed = true;
    }
    if (evt.keyCode == SPACE_KEY) {
      spacePressed = true;
    }
    if (evt.keyCode == Q_KEY) {
      qKeyPressed = true;
      if (gameState == 'playing') {
        player.shooting();
      }
    }
    if (evt.keyCode == X_KEY) {
      xKeyPressed = true;
    } // end of player 1
  } //end of keyPressed

  function keyReleased(evt) {
    if (evt.keyCode == A_KEY) {
      aKeyPressed = false;
    }
    if (evt.keyCode == D_KEY) {
      dKeyPressed = false;
    }
    if (evt.keyCode == W_KEY) {
      wKeyPressed = false;
    }
    if (evt.keyCode == S_KEY) {
      sKeyPressed = false;
    }
    if (evt.keyCode == SPACE_KEY) {
      spacePressed = false;
    }
    if (evt.keyCode == Q_KEY) {
      qKeyPressed = false;
    }
    if (evt.keyCode == X_KEY) {
      xKeyPressed = false;
    } //end of player 1
  } //end of keyReleased

  function drawImage(src, x, y, w, h) {
    canvasContext.drawImage(src, x, y, w, h);
  } //end of drawImage

  function drawLine(canvasContext, begin, end, stroke = 'grey', width = 1) {
    canvasContext.beginPath();
    canvasContext.moveTo(...begin); //could make variables for (x,y)
    canvasContext.lineTo(...end);
    canvasContext.stroke();
    canvasContext.strokeStyle = stroke;
    canvasContext.lineWidth = width;
  } //end of drawLine

  function drawTriangle() {
    canvasContext.beginPath();
    canvasContext.moveTo(0, 602.5);
    canvasContext.lineTo(canvas.width, canvas.height);
    canvasContext.lineTo(168, 304.5);
    canvasContext.fill();
  } //end of drawTriangle

  function drawSquare(x, y, w, h, c) {
    canvasContext.fillStyle = c;
    canvasContext.fillRect(x, y, w, h);
    canvasContext.strokeRect(x, y, w, h);
    canvasContext.lineWidth = 2.5;
  } //end of drawSquare

  function drawText(text, x, y, f, c) {
    canvasContext.font = f;
    canvasContext.fillStyle = c;
    canvasContext.fillText(text, x, y);
  } //end of drawText

  function colorRect(x, y, w, h, c) {
    canvasContext.fillStyle = c;
    canvasContext.fillRect(x, y, w, h);
  } //end of colorRect
</script>
<style>
  * {
    margin: 0px;
    padding: 0px;
  }

  canvas {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    margin-top: 5vh;
    display: block;
  }
</style>